---
// PS3-style Trophy notification component
---

<div id="trophy-notification" class="trophy-notification hidden">
  <div class="trophy-content">
    <div class="trophy-icon-container">
      <div class="trophy-glow"></div>
      <svg id="trophy-svg" class="trophy-3d" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Trophy Cup -->
        <defs>
          <linearGradient id="trophy-gradient-bronze" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#cd7f32;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#b87333;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#8b6914;stop-opacity:1" />
          </linearGradient>
          <linearGradient id="trophy-gradient-silver" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#e8e8e8;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#c0c0c0;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#9c9c9c;stop-opacity:1" />
          </linearGradient>
          <linearGradient id="trophy-gradient-gold" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#ffb700;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#cc8800;stop-opacity:1" />
          </linearGradient>
          <linearGradient id="trophy-gradient-platinum" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#e5e4e2;stop-opacity:1" />
            <stop offset="30%" style="stop-color:#b8e0f6;stop-opacity:1" />
            <stop offset="70%" style="stop-color:#c4e3f7;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#a8c5d8;stop-opacity:1" />
          </linearGradient>
          <radialGradient id="trophy-shine">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
          </radialGradient>
        </defs>
        
        <!-- Trophy body -->
        <path id="trophy-body" d="M30 30 Q30 25 35 25 L65 25 Q70 25 70 30 L70 50 Q70 65 50 68 Q30 65 30 50 Z" 
              fill="url(#trophy-gradient-bronze)" stroke="#000" stroke-width="1" opacity="0.9"/>
        
        <!-- Trophy handles -->
        <path d="M25 30 Q20 30 18 35 Q20 40 25 40" fill="url(#trophy-gradient-bronze)" stroke="#000" stroke-width="0.5"/>
        <path d="M75 30 Q80 30 82 35 Q80 40 75 40" fill="url(#trophy-gradient-bronze)" stroke="#000" stroke-width="0.5"/>
        
        <!-- Trophy base -->
        <rect x="40" y="68" width="20" height="5" fill="url(#trophy-gradient-bronze)" stroke="#000" stroke-width="0.5"/>
        <rect x="35" y="73" width="30" height="7" rx="2" fill="url(#trophy-gradient-bronze)" stroke="#000" stroke-width="0.5"/>
        
        <!-- Highlight shine -->
        <ellipse cx="45" cy="35" rx="10" ry="15" fill="url(#trophy-shine)" opacity="0.6"/>
      </svg>
    </div>
    <div class="trophy-text">
      <div class="trophy-label">You have earned a trophy</div>
      <h4 id="trophy-title" class="trophy-title">Trophy Title</h4>
    </div>
  </div>
</div>

<style>
  .trophy-notification {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 9999;
    width: 360px;
    background: linear-gradient(135deg, rgba(45, 55, 72, 0.92) 0%, rgba(30, 40, 55, 0.92) 100%);
    backdrop-filter: blur(20px);
    border-radius: 8px;
    padding: 16px 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7), 
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
    transform: translateX(-420px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .trophy-notification.show {
    transform: translateX(0);
    opacity: 1;
  }

  .trophy-notification.hide {
    transform: translateX(-420px) translateY(-20px);
    opacity: 0;
    transition: all 0.4s ease-out;
  }

  .trophy-content {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .trophy-icon-container {
    position: relative;
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .trophy-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
    border-radius: 50%;
    animation: glow-pulse 2s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% {
      opacity: 0.5;
      transform: translate(-50%, -50%) scale(0.9);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }
  }

  .trophy-3d {
    width: 60px;
    height: 60px;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
    animation: trophy-entrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes trophy-entrance {
    0% {
      transform: scale(0) rotate(-180deg);
      opacity: 0;
    }
    60% {
      transform: scale(1.15) rotate(10deg);
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  .trophy-text {
    flex: 1;
    animation: text-fade-in 0.4s ease-out 0.3s both;
  }

  @keyframes text-fade-in {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .trophy-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 500;
    margin-bottom: 6px;
  }

  .trophy-title {
    font-size: 17px;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
    line-height: 1.3;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  @media (max-width: 768px) {
    .trophy-notification {
      width: calc(100% - 40px);
      right: 20px;
      top: 70px;
    }
  }

  /* Trophy type colors */
  .trophy-notification[data-type="bronze"] .trophy-glow {
    background: radial-gradient(circle, rgba(205, 127, 50, 0.3) 0%, transparent 70%);
  }

  .trophy-notification[data-type="silver"] .trophy-glow {
    background: radial-gradient(circle, rgba(192, 192, 192, 0.3) 0%, transparent 70%);
  }

  .trophy-notification[data-type="gold"] .trophy-glow {
    background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
  }

  .trophy-notification[data-type="platinum"] .trophy-glow {
    background: radial-gradient(circle, rgba(180, 224, 246, 0.4) 0%, transparent 70%);
  }
</style>

<script>
  import { EasterEggManager, TROPHIES } from '../../utils/easter-eggs';

  let currentTimeout: number | null = null;
  let notificationQueue: string[] = [];
  let isShowingNotification = false;

  // Trophy type mapping based on how special/rare they are
  const trophyTypes: Record<string, string> = {
    'CONSOLE_EXPLORER': 'silver',
    'LOCATION_FINDER': 'bronze',
    'THEME_SWITCHER': 'bronze',
    'PROJECT_TESTER': 'bronze',
    'RESUME_READER': 'bronze',
    'PHOTO_COLLECTOR': 'gold',
    'SECTION_EXPLORER': 'silver',
    'PLATINUM_COLLECTOR': 'platinum',
  };

  function getTrophyGradient(type: string): string {
    switch(type) {
      case 'silver': return 'url(#trophy-gradient-silver)';
      case 'gold': return 'url(#trophy-gradient-gold)';
      case 'platinum': return 'url(#trophy-gradient-platinum)';
      default: return 'url(#trophy-gradient-bronze)';
    }
  }

  function processQueue() {
    if (notificationQueue.length === 0 || isShowingNotification) {
      return;
    }

    const trophyId = notificationQueue.shift();
    if (!trophyId) return;

    showTrophyNotification(trophyId);
  }

  function showTrophyNotification(trophyId: string) {
    const trophy = TROPHIES[trophyId];
    if (!trophy) return;

    const notification = document.getElementById('trophy-notification');
    const title = document.getElementById('trophy-title');
    const trophyBody = document.getElementById('trophy-body');
    const trophySvg = document.getElementById('trophy-svg');

    if (!notification || !title || !trophyBody || !trophySvg) return;

    isShowingNotification = true;

    // Get trophy type
    const trophyType = trophyTypes[trophyId] || 'bronze';
    notification.setAttribute('data-type', trophyType);

    // Update trophy color
    trophyBody.setAttribute('fill', getTrophyGradient(trophyType));
    
    // Update SVG handles and base to match
    const handles = trophySvg.querySelectorAll('path:not(#trophy-body)');
    const rects = trophySvg.querySelectorAll('rect');
    handles.forEach(handle => handle.setAttribute('fill', getTrophyGradient(trophyType)));
    rects.forEach(rect => rect.setAttribute('fill', getTrophyGradient(trophyType)));

    // Update content
    title.textContent = trophy.title;

    // Clear any existing timeout
    if (currentTimeout) {
      clearTimeout(currentTimeout);
    }

    // Show notification
    notification.classList.remove('hidden', 'hide');
    // Trigger reflow
    void notification.offsetWidth;
    notification.classList.add('show');

    // Play trophy sound (you can add a sound file)
    // try {
    //   const audio = new Audio('/trophy-sound.mp3');
    //   audio.volume = 0.5;
    //   audio.play().catch(() => {
    //     // Silently fail if sound doesn't exist
    //   });
    // } catch (e) {
    //   // Ignore
    // }

    // Hide after 3 seconds
    currentTimeout = window.setTimeout(() => {
      notification.classList.remove('show');
      notification.classList.add('hide');
      
      setTimeout(() => {
        notification.classList.add('hidden');
        isShowingNotification = false;
        // Process next notification in queue
        processQueue();
      }, 400);
    }, 3000);
  }

  // Make function globally available
  (window as any).showTrophyNotification = showTrophyNotification;

  // Expose unlock function globally with queue support
  (window as any).unlockTrophy = (trophyId: string) => {
    const isNew = EasterEggManager.unlockTrophy(trophyId);
    if (isNew) {
      // Add to queue
      notificationQueue.push(trophyId);
      // Try to process queue
      processQueue();
      // Refresh dropdown if it exists
      (window as any).refreshTrophyDropdown?.();
    }
  };
</script>

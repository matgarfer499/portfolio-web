---
interface Props {
  name: string;
  phrases: string[];
}

const { name, phrases } = Astro.props;
---

<div>
  <h1 class="text-base sm:text-lg md:text-xl lg:text-2xl font-medium text-[var(--color-text-light)]">
    Hello there! I'm {name},
  </h1>
  <span
    class="decrypted-text block text-base sm:text-lg md:text-xl lg:text-2xl font-medium text-[var(--color-accent)] whitespace-nowrap overflow-hidden"
    data-text={phrases[0]}
    data-phrases={JSON.stringify(phrases)}>{phrases[0]}</span>
</div>

<script>
  const codeletters = "&#*+%?ยฃ@ยง$";
  let messageIndex = 0;
  let currentLength = 0;
  let fadeBuffer: Array<{c: number, l: string}> | false = false;
  let phrases: string[] = [];
  let element: HTMLElement | null = null;

  function generateRandomString(length: number): string {
    let randomText = '';
    while (randomText.length < length) {
      randomText += codeletters.charAt(Math.floor(Math.random() * codeletters.length));
    }
    return randomText;
  }

  function animateIn(): void {
    if (!element || !phrases.length) return;
    
    if (currentLength < phrases[messageIndex].length) {
      currentLength = currentLength + 2;
      if (currentLength > phrases[messageIndex].length) {
        currentLength = phrases[messageIndex].length;
      }
      
      const message = generateRandomString(currentLength);
      element.textContent = message;
      
      setTimeout(animateIn, 20);
    } else {
      setTimeout(animateFadeBuffer, 20);
    }
  }

  function animateFadeBuffer(): void {
    if (!element || !phrases.length) return;
    
    if (fadeBuffer === false) {
      fadeBuffer = [];
      for (let i = 0; i < phrases[messageIndex].length; i++) {
        fadeBuffer.push({
          c: Math.floor(Math.random() * 12) + 1,
          l: phrases[messageIndex].charAt(i)
        });
      }
    }
    
    let doCycles = false;
    let message = '';
    
    for (let i = 0; i < fadeBuffer.length; i++) {
      const fader = fadeBuffer[i];
      if (fader.c > 0) {
        doCycles = true;
        fader.c--;
        message += codeletters.charAt(Math.floor(Math.random() * codeletters.length));
      } else {
        message += fader.l;
      }
    }
    
    element.textContent = message;
    
    if (doCycles === true) {
      setTimeout(animateFadeBuffer, 50);
    } else {
      setTimeout(cycleText, 2000);
    }
  }

  function cycleText(): void {
    if (!element || !phrases.length) return;
    
    messageIndex = messageIndex + 1;
    if (messageIndex >= phrases.length) {
      messageIndex = 0;
    }
    
    currentLength = 0;
    fadeBuffer = false;
    
    setTimeout(animateIn, 200);
  }

  function initAnimation(): void {
    element = document.querySelector(".decrypted-text") as HTMLElement;
    if (element) {
      phrases = JSON.parse(element.dataset.phrases || "[]");
      setTimeout(animateIn, 100);
    }
  }

  document.addEventListener("astro:page-load", initAnimation);
  initAnimation();
</script>
